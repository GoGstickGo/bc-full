<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Node Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: none;
            font-weight: bold;
        }
        .icon-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .bg-orange {
            background-color: #fd7e14;
        }
        .bg-primary-light {
            background-color: #cfe2ff;
        }
        .bg-success-light {
            background-color: #d1e7dd;
        }
        .bg-warning-light {
            background-color: #fff3cd;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .last-updated {
            font-size: 0.8rem;
            color: #6c757d;
        }
        #connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #mempool-chart, #block-height-chart {
            height: 250px;
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fab fa-bitcoin text-warning me-2"></i>
                Bitcoin Node Monitor
            </a>
            <div id="connection-status" class="badge bg-secondary">Connecting...</div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Block Height -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-primary-light">
                            <i class="fas fa-cube text-primary fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Block Height</div>
                            <div id="block-height" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connections -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-success-light">
                            <i class="fas fa-network-wired text-success fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Connections</div>
                            <div id="connections" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mempool Size -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-warning-light">
                            <i class="fas fa-list text-warning fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Mempool</div>
                            <div id="mempool-size" class="stat-value">-</div>
                            <div id="mempool-bytes" class="stat-label">- bytes</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Hashrate -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container" style="background-color: #ffe5d0;">
                            <i class="fas fa-microchip text-orange fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Network Hashrate</div>
                            <div id="network-hashrate" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Fee Estimates -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        Fee Estimates
                    </div>
                    <div class="card-body">
                        <div id="fee-estimates">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Difficulty -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>
                        Network Difficulty
                    </div>
                    <div class="card-body">
                        <div id="difficulty" class="mb-3">Loading...</div>
                        <div class="progress">
                            <div id="difficulty-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Charts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-area me-2"></i>
                        Mempool Size History
                    </div>
                    <div class="card-body">
                        <div id="mempool-chart"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>
                        Block Height History
                    </div>
                    <div class="card-body">
                        <div id="block-height-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-3 mb-5">
            <div id="last-updated" class="last-updated">Last updated: -</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // WebSocket connection
        let socket;
        let reconnectInterval = 1000; // Start with 1s interval
        let maxReconnectInterval = 30000; // Max 30s interval
        let mempoolData = [];
        let blockHeightData = [];
        const maxDataPoints = 20;

        // Charts
        let mempoolChart;
        let blockHeightChart;

        function formatHashrate(hashrate) {
            if (hashrate < 1e3) return hashrate.toFixed(2) + " H/s";
            if (hashrate < 1e6) return (hashrate / 1e3).toFixed(2) + " KH/s";
            if (hashrate < 1e9) return (hashrate / 1e6).toFixed(2) + " MH/s";
            if (hashrate < 1e12) return (hashrate / 1e9).toFixed(2) + " GH/s";
            if (hashrate < 1e15) return (hashrate / 1e12).toFixed(2) + " TH/s";
            if (hashrate < 1e18) return (hashrate / 1e15).toFixed(2) + " PH/s";
            return (hashrate / 1e18).toFixed(2) + " EH/s";
        }

        function formatDifficulty(difficulty) {
            if (difficulty < 1e3) return difficulty.toFixed(2);
            if (difficulty < 1e6) return (difficulty / 1e3).toFixed(2) + " K";
            if (difficulty < 1e9) return (difficulty / 1e6).toFixed(2) + " M";
            if (difficulty < 1e12) return (difficulty / 1e9).toFixed(2) + " B";
            if (difficulty < 1e15) return (difficulty / 1e12).toFixed(2) + " T";
            return (difficulty / 1e15).toFixed(2) + " Q";
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            socket = new WebSocket(`${protocol}//${host}/ws`);

            socket.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('connection-status').className = 'badge bg-success';
                document.getElementById('connection-status').innerText = 'Connected';
                // Reset reconnection interval
                reconnectInterval = 1000;
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log(data.Message);
                updateDashboard(data);
            };

            socket.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').className = 'badge bg-danger';
                document.getElementById('connection-status').innerText = 'Disconnected';
                
                // Reconnect with exponential backoff
                setTimeout(function() {
                    connectWebSocket();
                    reconnectInterval = Math.min(reconnectInterval * 1.5, maxReconnectInterval);
                }, reconnectInterval);
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1073741824) return (bytes / 1048576).toFixed(2) + ' MB';
            return (bytes / 1073741824).toFixed(2) + ' GB';
        }

        function updateDashboard(data) {
            // Update basic stats
            document.getElementById('block-height').innerText = data.blockHeight.toLocaleString();
            document.getElementById('connections').innerText = data.connections;
            document.getElementById('mempool-size').innerText = data.memPoolSize.toLocaleString() + ' txns';
            document.getElementById('mempool-bytes').innerText = formatBytes(data.memPoolBytes);
            document.getElementById('network-hashrate').innerText = formatHashrate(data.networkHashrate);
            document.getElementById('difficulty').innerText = `Current: ${formatDifficulty(data.difficulty)}`;
            
            // Set difficulty progress bar (arbitrary scale)
            const difficultyPercentage = Math.min((data.difficulty / 5e13) * 100, 100);
            document.getElementById('difficulty-bar').style.width = `${difficultyPercentage}%`;
            document.getElementById('difficulty-bar').setAttribute('aria-valuenow', difficultyPercentage);

            // Update fee estimates
            let feeHTML = '<div class="row">';
            
            // Check if we have fee estimates
            if (data.mempoolFeeInfo) {
                // Economical fee
                if (data.mempoolFeeInfo.economical && data.mempoolFeeInfo.economical.feerate) {
                    const economicalFeerate = data.mempoolFeeInfo.economical.feerate;
                    feeHTML += `
                        <div class="col-md-6 mb-2">
                            <div class="alert alert-success mb-0">
                                <small class="d-block text-muted">Economical (2 blocks)</small>
                                <strong>${(economicalFeerate * 100000).toFixed(2)} sat/vB</strong>
                            </div>
                        </div>`;
                }
                
                // Conservative fee
                if (data.mempoolFeeInfo.conservative && data.mempoolFeeInfo.conservative.feerate) {
                    const conservativeFeerate = data.mempoolFeeInfo.conservative.feerate;
                    feeHTML += `
                        <div class="col-md-6 mb-2">
                            <div class="alert alert-warning mb-0">
                                <small class="d-block text-muted">Conservative (2 blocks)</small>
                                <strong>${(conservativeFeerate * 100000).toFixed(2)} sat/vB</strong>
                            </div>
                        </div>`;
                }
            }
            
            // If no fee estimates available
            if (feeHTML === '<div class="row">') {
                feeHTML += '<div class="col">No fee estimates available</div>';
            }
            
            feeHTML += '</div>';
            document.getElementById('fee-estimates').innerHTML = feeHTML;

            // Update last updated time
            const lastUpdated = new Date(data.lastUpdated).toLocaleString();
            document.getElementById('last-updated').innerText = `Last updated: ${lastUpdated}`;

            // Update chart data
            updateChartData(data);
        }

        function updateChartData(data) {
            const now = new Date().toLocaleTimeString();
            
            // Update mempool data
            mempoolData.push({
                time: now,
                value: data.memPoolSize
            });
            
            // Update block height data
            blockHeightData.push({
                time: now,
                value: data.blockHeight
            });
            
            // Limit data points
            if (mempoolData.length > maxDataPoints) {
                mempoolData.shift();
            }
            
            if (blockHeightData.length > maxDataPoints) {
                blockHeightData.shift();
            }
            
            // Update charts
            updateCharts();
        }

        function createCharts() {
            // Mempool Chart
            const mempoolCtx = document.getElementById('mempool-chart').getContext('2d');
            mempoolChart = new Chart(mempoolCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Mempool Size',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Block Height Chart
            const blockHeightCtx = document.getElementById('block-height-chart').getContext('2d');
            blockHeightChart = new Chart(blockHeightCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Block Height',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!mempoolChart || !blockHeightChart) return;
            
            // Update mempool chart
            mempoolChart.data.labels = mempoolData.map(item => item.time);
            mempoolChart.data.datasets[0].data = mempoolData.map(item => item.value);
            mempoolChart.update();
            
            // Update block height chart
            blockHeightChart.data.labels = blockHeightData.map(item => item.time);
            blockHeightChart.data.datasets[0].data = blockHeightData.map(item => item.value);
            blockHeightChart.update();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            createCharts();
            connectWebSocket();
            
            // Fetch initial data via API in case websocket is slow to connect
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                });
        });
    </script>
</body>
</html>