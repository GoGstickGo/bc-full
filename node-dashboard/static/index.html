<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Node Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: none;
            font-weight: bold;
        }
        .icon-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .bg-orange {
            background-color: #fd7e14;
        }
        .bg-primary-light {
            background-color: #cfe2ff;
        }
        .bg-success-light {
            background-color: #d1e7dd;
        }
        .bg-warning-light {
            background-color: #fff3cd;
        }
        .bg-info-light {
            background-color: #cff4fc;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .last-updated {
            font-size: 0.8rem;
            color: #6c757d;
        }
        #connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #size-on-disk-chart, #verification-progress-chart {
            height: 250px;
            width: 100%;
        }
        .chain-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        #onion-status-icon {
            min-width: 24px;
            text-align: center;
        }
        #onion-status-icon i {
            cursor: help;
        }
        .bg-bitcoin {
            background-color: #f7931a;
        }
        #balance {
            font-size: 1.4rem;
        }
        #version {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fab fa-bitcoin text-warning me-2"></i>
                Bitcoin Node Monitor
            </a>
            <div id="connection-status" class="badge bg-secondary">Connecting...</div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Chain Info -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Network</h5>
                        <span id="chain-info" class="badge chain-badge bg-primary">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Block Height -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-primary-light">
                            <i class="fas fa-cube text-primary fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Block Height</div>
                            <div id="block-height" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connections -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-success-light">
                            <i class="fas fa-network-wired text-success fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Connections</div>
                            <div id="connections" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onion Status -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div id="onion-icon-container" class="icon-container bg-secondary">
                            <i class="fas fa-user-secret fa-2x" id="onion-icon"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="stat-label">Tor Network</div>
                            <div class="d-flex align-items-center">
                                <div id="onion-status" class="stat-value me-2">-</div>
                                <div id="onion-status-icon">
                                    <i class="fas fa-question-circle text-secondary fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Size on Disk -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-warning-light">
                            <i class="fas fa-hdd text-warning fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Size on Disk</div>
                            <div id="size-on-disk" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Mempool Info -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container" style="background-color: #e7f3ff;">
                            <i class="fas fa-layer-group text-primary fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Mempool</div>
                            <div id="mempool-size" class="stat-value">-</div>
                            <div id="mempool-bytes" class="stat-label">- MB</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Balance -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container" style="background-color: #fff3cd;">
                            <i class="fab fa-bitcoin text-warning fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Wallet Balance</div>
                            <div id="balance" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Version -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container bg-info-light">
                            <i class="fas fa-code-branch text-info fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Node Version</div>
                            <div id="version" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Hashrate -->
            <div class="col-md-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-container" style="background-color: #ffe5d0;">
                            <i class="fas fa-microchip text-orange fa-2x"></i>
                        </div>
                        <div>
                            <div class="stat-label">Network Hashrate</div>
                            <div id="network-hashrate" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Fee Estimates -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        Fee Estimates
                    </div>
                    <div class="card-body">
                        <div id="fee-estimates">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Verification Progress -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-tasks me-2"></i>
                        Verification Progress
                    </div>
                    <div class="card-body">
                        <div id="verification-progress" class="mb-3">Loading...</div>
                        <div class="progress">
                            <div id="verification-progress-bar" class="progress-bar progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Difficulty -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>
                        Network Difficulty
                    </div>
                    <div class="card-body">
                        <div id="difficulty" class="mb-3">Loading...</div>
                        <div class="progress">
                            <div id="difficulty-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Charts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-area me-2"></i>
                        Disk Usage Growth (GB)
                    </div>
                    <div class="card-body">
                        <canvas id="size-on-disk-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>
                        Verification Progress History
                    </div>
                    <div class="card-body">
                        <canvas id="verification-progress-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-3 mb-5">
            <div id="last-updated" class="last-updated">Last updated: -</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        // WebSocket connection
        let socket;
        let reconnectInterval = 1000; // Start with 1s interval
        let maxReconnectInterval = 30000; // Max 30s interval
        let sizeOnDiskData = [];
        let verificationProgressData = [];
        const maxDataPoints = 20;

        // Charts
        let sizeOnDiskChart;
        let verificationProgressChart;

        function formatHashrate(hashrate) {
            if (hashrate < 1e3) return hashrate.toFixed(2) + " H/s";
            if (hashrate < 1e6) return (hashrate / 1e3).toFixed(2) + " KH/s";
            if (hashrate < 1e9) return (hashrate / 1e6).toFixed(2) + " MH/s";
            if (hashrate < 1e12) return (hashrate / 1e9).toFixed(2) + " GH/s";
            if (hashrate < 1e15) return (hashrate / 1e12).toFixed(2) + " TH/s";
            if (hashrate < 1e18) return (hashrate / 1e15).toFixed(2) + " PH/s";
            return (hashrate / 1e18).toFixed(2) + " EH/s";
        }

        function formatDifficulty(difficulty) {
            if (difficulty < 1e3) return difficulty.toFixed(2);
            if (difficulty < 1e6) return (difficulty / 1e3).toFixed(2) + " K";
            if (difficulty < 1e9) return (difficulty / 1e6).toFixed(2) + " M";
            if (difficulty < 1e12) return (difficulty / 1e9).toFixed(2) + " B";
            if (difficulty < 1e15) return (difficulty / 1e12).toFixed(2) + " T";
            return (difficulty / 1e15).toFixed(2) + " Q";
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1073741824) return (bytes / 1048576).toFixed(2) + ' MB';
            return (bytes / 1073741824).toFixed(2) + ' GB';
        }

        function formatMB(bytes) {
            return (bytes / 1048576).toFixed(2);
        }

        function formatGB(bytes) {
            return (bytes / 1073741824).toFixed(2);
        }

        function formatBalance(balance) {
            if (balance === -1) return 'Wallet Disabled';
            if (balance === 0) return '0.00000000 BTC';
            if (balance < 0.001) return balance.toFixed(8) + ' BTC';
            if (balance < 1) return balance.toFixed(6) + ' BTC';
            return balance.toFixed(4) + ' BTC';
        }

        function formatVersion(version) {
            if (!version) return 'Unknown';
            
            // Bitcoin Core version format: e.g., 270100 = 27.1.0
            const major = Math.floor(version / 10000);
            const minor = Math.floor((version % 10000) / 100);
            const patch = version % 100;
            
            return `${major}.${minor}.${patch}`;
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws`;
            
            console.log('Attempting WebSocket connection to:', wsUrl);
            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                console.log('WebSocket connected successfully');
                document.getElementById('connection-status').className = 'badge bg-success';
                document.getElementById('connection-status').innerText = 'Connected';
                // Reset reconnection interval
                reconnectInterval = 1000;
            };

            socket.onmessage = function(event) {
                console.log('WebSocket message received:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    console.log('Parsed data:', data);
                    updateDashboard(data);
                } catch (error) {
                    console.error('Error parsing WebSocket data:', error);
                }
            };

            socket.onclose = function(event) {
                console.log('WebSocket disconnected. Code:', event.code, 'Reason:', event.reason);
                document.getElementById('connection-status').className = 'badge bg-danger';
                document.getElementById('connection-status').innerText = 'Disconnected';
                
                // Reconnect with exponential backoff
                setTimeout(function() {
                    console.log('Attempting WebSocket reconnection...');
                    connectWebSocket();
                    reconnectInterval = Math.min(reconnectInterval * 1.5, maxReconnectInterval);
                }, reconnectInterval);
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function updateDashboard(data) {
            console.log('Updating dashboard with data:', data);
            
            // Update basic stats
            console.log('Setting block height:', data.blockHeight);
            document.getElementById('block-height').innerText = data.blockHeight ? data.blockHeight.toLocaleString() : 'N/A';
            
            console.log('Setting connections:', data.connections);
            document.getElementById('connections').innerText = data.connections || 'N/A';
            
            // Update onion status
            console.log('Setting onion status:', data.onionStatus);
            console.log('Checking typo version:', data.onionStaus); // Check for typo
            console.log('Onion status type:', typeof data.onionStatus);
            
            // Handle both correct spelling and typo temporarily
            const onionStatusValue = data.onionStatus !== undefined ? data.onionStatus : data.onionStaus;
            
            console.log('Final onion status value:', onionStatusValue);
            console.log('Onion status === true:', onionStatusValue === true);
            
            const onionElement = document.getElementById('onion-status');
            const onionIconContainer = document.getElementById('onion-icon-container');
            const onionIcon = document.getElementById('onion-icon');
            const onionStatusIcon = document.getElementById('onion-status-icon');
            
            if (onionStatusValue === true) {
                console.log('Setting onion status to ACTIVE');
                onionElement.innerText = 'Active';
                onionIconContainer.className = 'icon-container bg-success-light';
                onionIcon.className = 'fas fa-user-secret text-success fa-2x';
                onionStatusIcon.innerHTML = '<i class="fas fa-check-circle text-success fa-lg" title="Tor network is reachable"></i>';
            } else if (onionStatusValue === false) {
                console.log('Setting onion status to INACTIVE');
                onionElement.innerText = 'Inactive';
                onionIconContainer.className = 'icon-container bg-danger';
                onionIcon.className = 'fas fa-user-secret text-white fa-2x';
                onionStatusIcon.innerHTML = '<i class="fas fa-times-circle text-danger fa-lg" title="Tor network is not reachable"></i>';
            } else {
                console.log('Setting onion status to UNKNOWN, actual value:', onionStatusValue);
                onionElement.innerText = 'Unknown';
                onionIconContainer.className = 'icon-container bg-secondary';
                onionIcon.className = 'fas fa-user-secret text-white fa-2x';
                onionStatusIcon.innerHTML = '<i class="fas fa-question-circle text-secondary fa-lg" title="Tor network status unknown"></i>';
            }
            
            // Update size on disk
            console.log('Setting size on disk:', data.chainInfo?.size_on_disk);
            const sizeOnDisk = data.chainInfo?.size_on_disk;
            if (sizeOnDisk) {
                document.getElementById('size-on-disk').innerText = formatBytes(sizeOnDisk);
            } else {
                document.getElementById('size-on-disk').innerText = 'N/A';
            }
            
            // Update mempool info
            console.log('Setting mempool size:', data.memPoolSize);
            console.log('Setting mempool bytes:', data.memPoolBytes);
            console.log('Setting mempool bytes:', data.memPoolFee);
            if (data.memPoolSize !== undefined && data.memPoolSize !== null) {
                document.getElementById('mempool-size').innerText = data.memPoolSize.toLocaleString() + ' txns';
            } else {
                document.getElementById('mempool-size').innerText = 'N/A';
            }
            
            if (data.memPoolBytes !== undefined && data.memPoolBytes !== null) {
                document.getElementById('mempool-bytes').innerText = formatMB(data.memPoolBytes) + ' MB';
            } else {
                document.getElementById('mempool-bytes').innerText = 'N/A';
            }
            // Update fee estimates
            console.log('Setting fee estimates:', data.mempoolFeeInfo);
            let feeHTML = '<div class="row">';
            
            // Check if we have fee estimates
            if (data.mempoolFeeInfo) {
                // Economical fee
                if (data.mempoolFeeInfo.economical) {
                    if (data.mempoolFeeInfo.economical.error) {
                        feeHTML += `
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-warning mb-0">
                                    <small class="d-block text-muted">Economical (2 blocks)</small>
                                    <strong>Fee estimation disabled</strong>
                                </div>
                            </div>`;
                    } else if (data.mempoolFeeInfo.economical.feerate) {
                        const economicalFeerate = data.mempoolFeeInfo.economical.feerate;
                        feeHTML += `
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-success mb-0">
                                    <small class="d-block text-muted">Economical (2 blocks)</small>
                                    <strong>${(economicalFeerate * 100000).toFixed(2)} sat/vB</strong>
                                </div>
                            </div>`;
                    }
                }
                
                // Conservative fee
                if (data.mempoolFeeInfo.conservative) {
                    if (data.mempoolFeeInfo.conservative.error) {
                        feeHTML += `
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-warning mb-0">
                                    <small class="d-block text-muted">Conservative (2 blocks)</small>
                                    <strong>Fee estimation disabled</strong>
                                </div>
                            </div>`;
                    } else if (data.mempoolFeeInfo.conservative.feerate) {
                        const conservativeFeerate = data.mempoolFeeInfo.conservative.feerate;
                        feeHTML += `
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-info mb-0">
                                    <small class="d-block text-muted">Conservative (2 blocks)</small>
                                    <strong>${(conservativeFeerate * 100000).toFixed(2)} sat/vB</strong>
                                </div>
                            </div>`;
                    }
                }
            }
            
            // If no fee estimates available
            if (feeHTML === '<div class="row">') {
                feeHTML += '<div class="col"><div class="alert alert-secondary mb-0">No fee estimates available</div></div>';
            }
            
            feeHTML += '</div>';
            document.getElementById('fee-estimates').innerHTML = feeHTML;
            
            // Update network hashrate
            console.log('Setting network hashrate:', data.networkHashrate);
            document.getElementById('network-hashrate').innerText = data.networkHashrate ? formatHashrate(data.networkHashrate) : 'N/A';
            
            // Update balance
            console.log('Setting balance:', data.balance);
            const balanceElement = document.getElementById('balance');
            if (data.balance !== undefined && data.balance !== null) {
                balanceElement.innerText = formatBalance(data.balance);
            } else {
                balanceElement.innerText = 'N/A';
            }
            
            // Update version
            console.log('Setting version:', data.version);
            const versionElement = document.getElementById('version');
            if (data.version !== undefined && data.version !== null) {
                versionElement.innerText = formatVersion(data.version);
            } else {
                versionElement.innerText = 'N/A';
            }
            
            // Update chain info
            console.log('Setting chain info:', data.chainInfo?.chain);
            const chainElement = document.getElementById('chain-info');
            if (data.chainInfo?.chain) {
                chainElement.innerText = data.chainInfo.chain.toUpperCase();
                chainElement.className = data.chainInfo.chain === 'main' ? 'badge chain-badge bg-success' : 'badge chain-badge bg-warning';
            } else {
                chainElement.innerText = 'Unknown';
                chainElement.className = 'badge chain-badge bg-secondary';
            }
            
            // Update verification progress
            console.log('Setting verification progress:', data.chainInfo?.verificationprogress);
            const verificationProgress = data.chainInfo?.verificationprogress;
            if (verificationProgress !== undefined) {
                const progressPercent = (verificationProgress * 100).toFixed(2);
                document.getElementById('verification-progress').innerText = `${progressPercent}% Complete`;
                document.getElementById('verification-progress-bar').style.width = `${progressPercent}%`;
                document.getElementById('verification-progress-bar').setAttribute('aria-valuenow', progressPercent);
                
                // Change color based on progress
                const progressBar = document.getElementById('verification-progress-bar');
                if (verificationProgress >= 0.999) {
                    progressBar.className = 'progress-bar bg-success';
                } else if (verificationProgress >= 0.95) {
                    progressBar.className = 'progress-bar bg-warning';
                } else {
                    progressBar.className = 'progress-bar bg-info';
                }
            } else {
                document.getElementById('verification-progress').innerText = 'N/A';
            }
            
            console.log('Setting difficulty:', data.difficulty);
            document.getElementById('difficulty').innerText = data.difficulty ? `Current: ${formatDifficulty(data.difficulty)}` : 'N/A';
            
            // Set difficulty progress bar (arbitrary scale)
            if (data.difficulty) {
                const difficultyPercentage = Math.min((data.difficulty / 5e13) * 100, 100);
                document.getElementById('difficulty-bar').style.width = `${difficultyPercentage}%`;
                document.getElementById('difficulty-bar').setAttribute('aria-valuenow', difficultyPercentage);
            }

            // Update last updated time
            const lastUpdated = new Date(data.lastUpdated).toLocaleString();
            document.getElementById('last-updated').innerText = `Last updated: ${lastUpdated}`;

            // Update chart data
            updateChartData(data);
        }

        function updateChartData(data) {
            const now = new Date().toLocaleTimeString();
            
            // Update size on disk data (in GB)
            if (data.chainInfo?.size_on_disk) {
                sizeOnDiskData.push({
                    time: now,
                    value: parseFloat(formatGB(data.chainInfo.size_on_disk))
                });
            }
            
            // Update verification progress data
            if (data.chainInfo?.verificationprogress !== undefined) {
                verificationProgressData.push({
                    time: now,
                    value: data.chainInfo.verificationprogress * 100
                });
            }
            
            // Limit data points
            if (sizeOnDiskData.length > maxDataPoints) {
                sizeOnDiskData.shift();
            }
            
            if (verificationProgressData.length > maxDataPoints) {
                verificationProgressData.shift();
            }
            
            // Update charts
            updateCharts();
        }

        function createCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                return;
            }

            // Check if canvas elements exist
            const sizeOnDiskCanvas = document.getElementById('size-on-disk-chart');
            const verificationProgressCanvas = document.getElementById('verification-progress-chart');
            
            if (!sizeOnDiskCanvas || !verificationProgressCanvas) {
                console.error('Chart canvas elements not found!');
                return;
            }

            // Size on Disk Chart
            const sizeOnDiskCtx = sizeOnDiskCanvas.getContext('2d');
            if (!sizeOnDiskCtx) {
                console.error('Failed to get 2D context for size on disk chart');
                return;
            }

            sizeOnDiskChart = new Chart(sizeOnDiskCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Size on Disk (GB)',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Gigabytes (GB)'
                            }
                        }
                    }
                }
            });
            
            // Verification Progress Chart
            const verificationProgressCtx = verificationProgressCanvas.getContext('2d');
            if (!verificationProgressCtx) {
                console.error('Failed to get 2D context for verification progress chart');
                return;
            }

            verificationProgressChart = new Chart(verificationProgressCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Verification Progress (%)',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            }
                        }
                    }
                }
            });

            console.log('Charts created successfully');
        }

        function updateCharts() {
            if (!sizeOnDiskChart || !verificationProgressChart) return;
            
            // Update size on disk chart
            sizeOnDiskChart.data.labels = sizeOnDiskData.map(item => item.time);
            sizeOnDiskChart.data.datasets[0].data = sizeOnDiskData.map(item => item.value);
            sizeOnDiskChart.update();
            
            // Update verification progress chart
            verificationProgressChart.data.labels = verificationProgressData.map(item => item.time);
            verificationProgressChart.data.datasets[0].data = verificationProgressData.map(item => item.value);
            verificationProgressChart.update();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dashboard...');
            
            // Try to create charts, but continue if it fails
            try {
                createCharts();
            } catch (error) {
                console.error('Failed to create charts:', error);
                console.log('Continuing without charts...');
            }
            
            connectWebSocket();
            
            // Fetch initial data via API in case websocket is slow to connect
            console.log('Fetching initial data from API...');
            fetch('/api/stats')
                .then(response => {
                    console.log('API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API data received:', data);
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Error fetching stats from API:', error);
                });
        });
    </script>
</body>
</html>